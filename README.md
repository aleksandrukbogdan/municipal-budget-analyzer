# Анализ бюджетов муниципальных образований

Система автоматического анализа бюджетных документов МО для выявления капитальных расходов.

## Описание

Пайплайн извлекает статьи расходов из Excel-файлов бюджетов, классифицирует их на капитальные/не капитальные через LLM или по ключевым словам, и формирует сводные отчёты.

## Структура проекта

```
ugmk_gos1/
├── pipeline.py              # Главный пайплайн (точка входа)
├── extract_articles.py      # Извлечение статей из Excel
├── llm_classifier.py        # Классификация через LLM
├── calculate_costs.py       # Подсчёт стоимости по категориям
├── make_summary_report.py   # Формирование сводного отчёта
├── test_llm_connection.py   # Тестирование подключения к LLM
├── requirements.txt         # Зависимости Python
├── .env                     # Настройки подключения к LLM
├── input/                   # Входные Excel файлы бюджетов
└── output/                  # Выходные файлы
    ├── extracted_articles.json      # Все извлечённые статьи
    ├── classified_articles.json     # Классифицированные статьи
    ├── llm_classification_log.txt   # Лог LLM классификации
    ├── budget_capital_expenses.xlsx # Детальные данные
    ├── budget_totals.json           # Итоговые суммы
    └── Сводный_Отчет_Бюджет.xlsx    # Сводный отчёт
```

## Установка

```bash
# Создание виртуального окружения
python -m venv venv

# Активация (Windows)
.\venv\Scripts\activate

# Установка зависимостей
pip install -r requirements.txt
```

## Настройка LLM

Создайте файл `.env`:

```env
QWEN_API_KEY="sk-dummy-key"
QWEN_BASE_URL=http://localhost:8880/v1
QWEN_MODEL_NAME="default"
```

Проверьте подключение:

```bash
python test_llm_connection.py
```

## Использование

### Полный пайплайн с LLM

```bash
python pipeline.py
```

### Классификация по ключевым словам (без LLM)

```bash
python pipeline.py --skip-llm
```

### Другие опции

```bash
python pipeline.py --help

Опции:
  --skip-llm          Пропустить LLM, использовать ключевые слова
  --extract-only      Только извлечь статьи (этап 1)
  --from-classified   Начать с уже классифицированных данных
  --no-report         Не создавать сводный отчёт
```

## Этапы пайплайна

### 1. Извлечение статей (`extract_articles.py`)

Читает Excel файлы из `input/`, находит "Ведомственную структуру расходов", извлекает строки типа "Article" (статьи расходов).

### 2. Классификация (`llm_classifier.py`)

Отправляет статьи батчами в LLM для определения:
- **Капитальные**: строительство, реконструкция, капремонт, модернизация
- **Не капитальные**: содержание, текущий ремонт, выплаты, жилой фонд

### 3. Подсчёт стоимости (`calculate_costs.py`)

Группирует статьи по МО и категориям:
- Объекты образования (раздел 07)
- Здравоохранение, культура, спорт (разделы 08, 11)
- Транспортная инфраструктура (подразделы 0408, 0409)
- Благоустройство и ЖКХ (подразделы 0502, 0503)

### 4. Сводный отчёт (`make_summary_report.py`)

Формирует Excel с листами по годам и динамикой.

## Входные файлы

Поддерживаются файлы `.xls` и `.xlsx` с названиями, содержащими:
- "бюджет" и год (например, "Бюджет 2025")
- "прил" и "4" или "5"
- "ведомств"
- "расход"

## Выходные файлы

| Файл | Описание |
|------|----------|
| `extracted_articles.json` | Все статьи до классификации |
| `classified_articles.json` | Только капитальные статьи |
| `llm_classification_log.txt` | Лог: что принято/отклонено |
| `budget_capital_expenses.xlsx` | Детальная таблица |
| `Сводный_Отчет_Бюджет.xlsx` | Итоговый отчёт |

## Требования

- Python 3.10+
- pandas, openpyxl, xlrd
- requests, python-dotenv
- LLM сервер (vLLM) для режима с LLM



